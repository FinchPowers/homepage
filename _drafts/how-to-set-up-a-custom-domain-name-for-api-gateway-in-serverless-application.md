# How to set up a custom domain name for API Gateway in Serverless application?

When you deploy your Serverless application with API Gateway, the API endpoint created by API Gateway looks like:
```
https://xxxxxxxxxx.execute-api.REGION.amazonaws.com/STAGE/
```
**xxxxxxxxxx** is the API ID generated by API Gateway for the new API endpoint. For example if you deploy run `sls deploy -s dev -r us-east-1`, you will get an API endpoint looks like
```
https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/dev/
```

The API ID is managed by API Gateway and is unique to your API project. If you remove and re-deploy your app, you get a new ID, meaning a new API endpoint. No way to get the original ID back. If the API endpoint was given to other services, (ie. used as webhook in GitHub, Slack, etc), you need to update each of the services.

Solution is to use a custom domain for API, and map it to your API Gateway endpoint. If your API Gateway endpoint change in the case of a redeploy, you just need to update the mapping.

### Pre-requisites
- A domain name on AWS Route53. We are going to use **api.seed-frank-playground.download** in this post. If you don't have a domain name, you can buy one on [Route53](link-to-post).
- A Serverless Framework with project with API Gateway endpoint. Here is a sample repo [serverless-example-with-custom-domain](https://github.com/seed-run/serverless-example-with-custom-domain)

### AWS services used
- Cloud Front: CDN network for your API
- Route 53: Host domain DNS records and redirct traffic to your API endpoint
- ACM: Certificate manager for issuing SSL cert for your domain
- API Gateway: Manages the path mappings between the custom domain and API projects

### Setup custom domain
First, let's go create. Go to AWS console and search for the **Certificate Manager** service.
![](https://i.imgur.com/zg9CzbT.png)

Click on **Get Started** under **Provision certificates**
![](https://i.imgur.com/UJC2ZWj.png)

Select **Request a public certificate** and hit **Request a certificate**
![](https://i.imgur.com/Q8BBs9H.png)

Enter ***.seed-frank-playground.download** for domain name, and select **Next**
![](https://i.imgur.com/MEXEVsk.png)

Amazon needs to validate that you own the domain. There are two common ways:
1. DNS validation: you add a specific CNAME record to prove you have access to the domain's DNS record; or
2. Email validation: they send you an email, you need to click through the verification link in the email
We will select DNS validation, and since our domain is hosted on Route 53, ACM can help us set it up automatically which we will see below.

Select **DNS Validation** and select **Review**
![](https://i.imgur.com/xN5Mf9f.png)

Select **Confirm and request**
![](https://i.imgur.com/mjihhA8.png)

You see validation status in **Pending validation**. Select **Create record in Route 53**.
![](https://i.imgur.com/h43ps7O.png)

Select **Create**
![](https://i.imgur.com/qfL5pDG.png)

Scroll down and you will see a **Success** message. Select **Continue**
![](https://i.imgur.com/oYb1iRF.png)

Give it a couple of minutes for the validation. After which you will see the certificate status being **Issued**
![](https://i.imgur.com/AwzlIEV.png)

Now, go back to code. We are going to use **serverless-domain-manager** to help us setup the domain.

In your CLI, navigate to the your serverless directory, and run
```bash=
$ npm install serverless-domain-manager --save-dev
```

Then add the following block in serverless.yml
```yaml=
...
plugins:
  - serverless-domain-manager

custom:
  customDomain:
    domainName: api.seed-frank-playground.download
...
```

You can configure a base path to use for your custom domain, ie. https://api.seed-frank-playground.download/hello by setting
```yaml=
...
plugins:
  - serverless-domain-manager

custom:
  customDomain:
    domainName: api.seed-frank-playground.download
    basePath: hello
...
```

Before deploying, first run
```bash=
$ serverless create_domain --stage dev
Serverless: Custom domain api.seed-frank-playground.download was created.
            New domains may take up to 40 minutes to be initialized.
```

As the output suggests, setting up the custom domain can take up to 40 minutes to setup the CloudFront distribution for API Gateway.

After the domain is configured, deploy your service.
```bash=  
$ serverless deploy --stage dev
```

You should see the custom domain info printed at the end
```
Domain Name
  api.seed-frank-playground.download
Distribution Domain Name
  Target Domain: dpy3yzw5vvuwe.cloudfront.net
  Hosted Zone Id: Z2FDTNDATAQYW2
```

Now you can curl your API endpoint using the custom domain
```bash=
$ curl https://api.seed-frank-playground.download
```

### Remove custom domain

To remove the custom domain created, run
```bash=
$ serverless delete_domain --stage dev
```

And manually remove the certificate in the ACM console, as well as the domain's validation CNAME record in Route 53.

### A couple things to note
- With custom domain configured, the default endpoint https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/dev/ still exists and can be used.
- Custom Domain is not a property of your API Gateway project. It sits on top of all API Gateway projects. You just tell API Gateway to route the API request to your API project when /BASE_PATH is invoked on the custom domain.
- CloudFormation does not support changing the base path from empty to something or vice a versa. You must run sls remove to remove the base path mapping.
